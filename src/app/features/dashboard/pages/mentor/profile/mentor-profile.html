<div class="pb-20">
  @if (profileStore.isLoading()) {
  <div class="flex flex-col justify-center items-center py-24">
    <div class="relative">
      <div class="w-16 h-16 border-4 border-brand-200 border-t-brand-600 rounded-full animate-spin"></div>
      <div
        class="absolute inset-0 w-16 h-16 border-4 border-transparent border-b-brand-400 rounded-full animate-ping"></div>
    </div>
    <p class="mt-6 text-slate-600 font-medium animate-pulse">Chargement du profil...</p>
  </div>
  } @else { @if (profileStore.profile(); as profile) {
  <div class="dashboard-grid">
    <div class="col-span-12">
      <div class="dashboard-card p-6">
        <div class="flex items-center justify-between flex-wrap gap-4">
          <div class="flex items-center gap-4">
            <div
              class="w-14 h-14 rounded-xl bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center shadow-lg">
              <span class="material-icons text-white text-3xl">badge</span>
            </div>
            <div>
              <h1 class="dashboard-heading-3">Mon Profil Mentor</h1>
              <p class="dashboard-text-body">Gérez vos informations professionnelles</p>
            </div>
          </div>

          <div class="flex items-center gap-3">
            <span [class]="getStatusBadgeClass()">
              <span class="material-icons text-[14px]">{{ getStatusIcon() }}</span>
              {{ getStatusLabel() }}
            </span>

            @if (!isEditMode()) {
            <button type="button" (click)="enableEditMode()" class="dashboard-btn-primary">
              <span class="material-icons text-sm">edit</span>
              Modifier
            </button>
            }
          </div>
        </div>
      </div>
    </div>

    <div class="col-span-12">
      <form [formGroup]="profileForm" (ngSubmit)="onSubmit()">
        <div class="dashboard-card p-6 mb-6">
          <div class="flex items-center gap-3 mb-6">
            <div class="dashboard-stat-icon bg-gradient-to-br from-blue-500 to-indigo-600">
              <span class="material-icons text-white text-xl">work</span>
            </div>
            <div>
              <h2 class="dashboard-heading-4">Expérience professionnelle</h2>
              <p class="dashboard-text-tiny">Années d'expérience totales</p>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="years_experience">
              Années d'expérience <span class="text-red-500">*</span>
            </label>
            <input
              id="years_experience"
              type="number"
              formControlName="years_experience"
              [readonly]="!isEditMode()"
              class="form-input"
              placeholder="Ex: 5"
              min="0" />
            @if (profileForm.get('years_experience')?.invalid && profileForm.get('years_experience')?.touched) {
            <p class="form-error">Ce champ est requis</p>
            }
          </div>
        </div>

        <div class="dashboard-card p-6 mb-6">
          <div class="flex items-center gap-3 mb-6">
            <div class="dashboard-stat-icon bg-gradient-to-br from-emerald-500 to-teal-600">
              <span class="material-icons text-white text-xl">psychology</span>
            </div>
            <div>
              <h2 class="dashboard-heading-4">Domaines d'expertise</h2>
              <p class="dashboard-text-tiny">Sélectionnez vos domaines de compétences</p>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            @for (expertise of profileStore.expertises(); track expertise.id) {
            <button
              type="button"
              [disabled]="!isEditMode()"
              (click)="isEditMode() ? toggleExpertise(expertise.id) : null"
              [class]="isExpertiseSelected(expertise.id)
                ? 'px-4 py-3 rounded-lg border-2 border-brand-500 bg-brand-50 text-brand-700 font-medium transition-all flex items-center justify-between'
                : 'px-4 py-3 rounded-lg border-2 border-slate-200 bg-white text-slate-700 font-medium hover:border-brand-300 transition-all flex items-center justify-between'">
              <span>{{ expertise.name }}</span>
              @if (isExpertiseSelected(expertise.id)) {
              <span class="material-icons text-brand-600 text-lg">check_circle</span>
              }
            </button>
            } @empty {
            <div class="col-span-full">
              <p class="dashboard-text-body text-center py-8">Aucune expertise disponible</p>
            </div>
            }
          </div>
        </div>

        <div class="dashboard-card p-6 mb-6">
          <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
              <div class="dashboard-stat-icon bg-gradient-to-br from-amber-500 to-orange-600">
                <span class="material-icons text-white text-xl">history_edu</span>
              </div>
              <div>
                <h2 class="dashboard-heading-4">Parcours professionnel</h2>
                <p class="dashboard-text-tiny">Vos expériences détaillées</p>
              </div>
            </div>

            @if (isEditMode()) {
            <button type="button" (click)="addExperience()" class="dashboard-btn-primary">
              <span class="material-icons text-sm">add</span>
              Ajouter une expérience
            </button>
            }
          </div>

          <div formArrayName="experiences" class="space-y-4">
            @for (experience of experiencesArray.controls; track $index; let i = $index) {
            <div [formGroupName]="i" class="p-5 rounded-lg border-2 border-slate-200 bg-slate-50">
              <div class="flex items-start justify-between mb-4">
                <h3 class="dashboard-heading-5 text-slate-800">Expérience {{ i + 1 }}</h3>
                @if (isEditMode()) {
                <button type="button" (click)="removeExperience(i)" class="dashboard-btn-danger">
                  <span class="material-icons">delete</span>
                </button>
                }
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                  <label class="form-label" for="company_name_{{i}}">
                    Entreprise <span class="text-red-500">*</span>
                  </label>
                  <input
                    id="company_name_{{i}}"
                    type="text"
                    formControlName="company_name"
                    [readonly]="!isEditMode()"
                    class="form-input"
                    placeholder="Ex: Google" />
                </div>

                <div class="form-group">
                  <label class="form-label" for="job_title"> Poste <span class="text-red-500">*</span> </label>
                  <input
                    type="text"
                    formControlName="job_title"
                    [readonly]="!isEditMode()"
                    class="form-input"
                    placeholder="Ex: Senior Developer" />
                </div>

                <div class="form-group">
                  <label class="form-label" for="start_date"> Date de début <span class="text-red-500">*</span> </label>
                  <input
                    type="date"
                    id="form-label"
                    formControlName="start_date"
                    [readonly]="!isEditMode()"
                    class="form-input" />
                </div>

                <div class="form-group">
                  <label class="form-label" for="end_date">Date de fin</label>
                  <input type="date" id="end_date" formControlName="end_date" class="form-input" />
                </div>

                <div class="col-span-full">
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input
                      type="checkbox"
                      formControlName="is_current"
                      [disabled]="!isEditMode()"
                      (change)="toggleCurrentPosition(i)"
                      class="w-4 h-4 text-brand-600 border-slate-300 rounded focus:ring-brand-500" />
                    <span class="dashboard-text-body">Poste actuel</span>
                  </label>
                </div>
              </div>
            </div>
            } @empty {
            <div class="p-8 text-center">
              <div
                class="w-16 h-16 mx-auto rounded-2xl bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center mb-4">
                <span class="material-icons text-slate-400 text-3xl">work_outline</span>
              </div>
              <p class="dashboard-text-body">Aucune expérience ajoutée</p>
              @if (isEditMode()) {
              <button type="button" (click)="addExperience()" class="dashboard-btn-primary mt-4">
                <span class="material-icons text-sm">add</span>
                Ajouter votre première expérience
              </button>
              }
            </div>
            }
          </div>
        </div>

        <div class="dashboard-card p-6 mb-6">
          <div class="flex items-center gap-3 mb-6">
            <div class="dashboard-stat-icon bg-gradient-to-br from-purple-500 to-pink-600">
              <span class="material-icons text-white text-xl">description</span>
            </div>
            <div>
              <h2 class="dashboard-heading-4">Curriculum Vitae</h2>
              <p class="dashboard-text-tiny">Téléchargez votre CV (PDF uniquement, max 1 MB)</p>
            </div>
          </div>

          <div class="space-y-4">
            @if (profile.cv) {
            <div class="flex items-center justify-between p-4 bg-primary-50 border-2 border-primary-200 rounded-lg">
              <div class="flex items-center gap-3">
                <span class="material-icons text-primary-500 text-2xl">check_circle</span>
                <div>
                  <p class="font-semibold text-primary-700">CV téléchargé</p>
                  <p class="text-sm text-primary-500">Votre CV est disponible</p>
                </div>
              </div>
              <a [href]="profileStore.cvUrl()" target="_blank" class="dashboard-btn-outline text-sm">
                <span class="material-icons text-sm">visibility</span>
                Voir
              </a>
            </div>
            } @if (isEditMode()) {
            <div class="relative">
              <input type="file" accept=".pdf" (change)="handleCVUpload($event)" class="hidden" #cvInput />
              <button
                type="button"
                (click)="cvInput.click()"
                [disabled]="profileStore.isUploadingCV()"
                class="w-full dashboard-btn-outline py-3">
                @if (profileStore.isUploadingCV()) {
                <span class="material-icons text-sm animate-spin">sync</span>
                <span>Téléchargement en cours...</span>
                } @else {
                <span class="material-icons text-sm">upload_file</span>
                <span>{{ profile.cv ? 'Remplacer le CV' : 'Télécharger le CV' }}</span>
                }
              </button>
            </div>
            }
          </div>
        </div>

        @if (isEditMode()) {
        <div class="flex items-center justify-end gap-3">
          <button type="button" (click)="cancelEdit()" class="dashboard-btn-outline">
            <span class="material-icons text-sm">close</span>
            Annuler
          </button>
          <button
            type="submit"
            [disabled]="profileStore.isLoading() || profileForm.invalid"
            class="dashboard-btn-primary">
            @if (profileStore.isLoading()) {
            <span class="material-icons text-sm animate-spin">sync</span>
            <span>Enregistrement...</span>
            } @else {
            <span class="material-icons text-sm">save</span>
            <span>Enregistrer</span>
            }
          </button>
        </div>
        }
      </form>
    </div>
  </div>
  } @else {
  <div class="flex flex-col items-center justify-center py-24">
    <div
      class="w-20 h-20 rounded-2xl bg-gradient-to-br from-red-100 to-red-200 flex items-center justify-center shadow-lg mb-4">
      <span class="material-icons text-red-500 text-4xl">error</span>
    </div>
    <h3 class="dashboard-heading-4 mb-2">Profil non trouvé</h3>
    <p class="dashboard-text-body text-center max-w-md mb-6">Nous n'avons pas pu charger votre profil mentor</p>
    <button (click)="ngOnInit()" class="dashboard-btn-primary">
      <span class="material-icons text-sm">refresh</span>
      Réessayer
    </button>
  </div>
  } }
</div>
