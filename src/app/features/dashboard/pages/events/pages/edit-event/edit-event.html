<section class="pt-32 dashboard-main-content flex flex-col gap-4">
  @let event = eventStore.event();
  <app-tabs [tabs]="tabs" [activeTab]="activeTab()" (tabChange)="onTabChange($event)" />
  @if (activeTab() === 'gallery') {
  <div class="w-full md:w-1/3">
    @if (eventStore.isLoading()) {
    <div class="h-20 bg-gray-200 animate-pulse rounded-lg w-full mb-4"></div>
    } @else {
    <app-file-upload [multiple]="true" [name]="'image'" [url]="galleryUrl + event?.id" (loaded)="onGalleryUploaded()" />
    }
  </div>
  <div class="flex flex-wrap gap-3">
    @for (image of galleryStore.gallery(); track image.id) {
    <div
      class="relative w-36 h-28 bg-gray-200 aspect-square rounded overflow-hidden border-2 border-slate-200/10 group last:mb-10">
      <img
        class="object-cover h-full"
        priority
        fill
        [ngSrc]="image | apiIMG: 'gallery'"
        [alt]="event?.name + ' gallery image'" />
      <button
        type="button"
        (click)="onDeleteImage(image.id)"
        class="absolute top-2 right-2 p-1.5 z-90 bg-red-500/80 hover:bg-red-600 rounded-full shadow-md opacity-0 group-hover:opacity-100 transition">
        <i-lucide [name]="icons.trash" class="w-4 h-4 text-white" />
      </button>
    </div>
    }
  </div>
  } @if (activeTab() === 'edit') {
  <form class="grid grid-cols-1 md:grid-cols-5 gap-5" [formGroup]="form" (ngSubmit)="onUpdateEvent()">
    <div class="col-span-2">
      <p class="font-medium mb-2">Photo de couverture</p>
      <div
        class="relative h-52 mb-6 w-full pb-8 px-8 lg:px-16 xl:px-24 2xl:px-32 max-w-screen-2xl mx-auto bg-gray-200 rounded">
        @if (event?.cover) {
        <img
          [ngSrc]="event | apiIMG: 'event'"
          [alt]="event?.name"
          class="object-cover h-full opacity-90 rounded border-2 border-slate-200/10"
          fill
          priority />
        }
      </div>
      @if (eventStore.isLoading()) {
      <div class="h-20 bg-gray-200 animate-pulse rounded-lg w-full mb-4"></div>
      } @else {
      <app-file-upload [name]="'cover'" [url]="url + event?.id" (loaded)="onCoverUploaded()" />
      }
    </div>
    <div class="flex flex-col gap-5 col-span-3">
      <div class="flex flex-col gap-1.5">
        <label for="name" class="font-medium"> Nom de l'événement<span class="text-red-500">*</span> </label>
        <input pInputText id="name" formControlName="name" />
      </div>
      <div class="flex flex-col gap-1.5">
        <label for="form_link" class="font-medium"> Lien du formulaire </label>
        <input pInputText id="form_link" formControlName="form_link" />
      </div>
      <div class="flex flex-col gap-1.5">
        <label for="place" class="font-medium"> Lieu </label>
        <input pInputText id="place" formControlName="place" />
      </div>
      <div class="flex flex-col gap-1.5 mb-10">
        <p class="font-medium">Description<span class="text-red-500">*</span></p>
        <quill-editor formControlName="description" [style]="{ height: '200px' }" />
      </div>
      <div class="flex flex-col gap-1.5">
        <p class="font-medium">Programme</p>
        <p-select
          inputId="program"
          [optionValue]="'id'"
          [optionLabel]="'name'"
          [options]="programsStore.subprograms()"
          formControlName="program"
          class="w-full" />
      </div>
      <div class="flex flex-col gap-1.5">
        <p class="font-medium">Catégories</p>
        <p-multiSelect
          [inputId]="'categories'"
          [autocomplete]="'off'"
          [optionValue]="'id'"
          [optionLabel]="'name'"
          [options]="categoriesStore.categories()"
          formControlName="categories" />
      </div>
      <div class="flex flex-col gap-1.5">
        <p class="font-medium">Date de début</p>
        <p-datePicker showIcon iconDisplay="input" formControlName="started_at" />
      </div>
      <div class="flex flex-col gap-1.5">
        <p class="font-medium">Date de fin</p>
        <p-datePicker showIcon iconDisplay="input" formControlName="ended_at" />
      </div>
      <div class="flex py-3 justify-between">
        <p-button
          [loading]="store.isLoading()"
          [disabled]="store.isLoading() || form.invalid"
          size="small"
          type="submit">
          Modifier l'événement
        </p-button>
      </div>
    </div>
  </form>
  } @if (activeTab() === 'report' && event) {
  <app-event-report [event]="event" />
  } @if (activeTab() === 'indicators') {
  <div class="p-4 bg-gray-50 rounded-lg w-full md:w-2/3">
    <p class="font-medium">Performance de l'événement :</p>
    <div class="flex justify-between items-center mt-2">
      <div>
        <span>Total Attendus: <strong>{{ totalTargeted }}</strong></span>
        <span class="ml-4">Total Obtenus: <strong>{{ totalAchieved }}</strong></span>
      </div>
      <div class="flex items-center gap-2">
        <span>{{ achievementPercentage }}%</span>
        <div class="w-40 h-4 bg-gray-200 rounded-full overflow-hidden">
          <div
            class="h-full"
            [style.width.%]="achievementPercentage"
            [ngClass]="{
              'bg-red-500': achievementPercentage < 50,
              'bg-yellow-500': achievementPercentage >= 50 && achievementPercentage < 80,
              'bg-green-500': achievementPercentage >= 80
            }"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="flex flex-col gap-4 w-full md:w-2/3">
    <table class="min-w-full rounded-lg">
      <thead class="bg-gray-100">
        <tr class="text-left">
          <th class="p-2 font-medium">Indicateurs</th>
          <th class="p-2 font-medium w-1/4">Attendus</th>
          <th class="p-2 font-medium w-1/4">Obtenus</th>
        </tr>
      </thead>
      <tbody>
        @for (ind of indicatorsStore.indicators(); track $index) {
        <tr>
          <td class="pt-4 pr-2">
            <input pInputText [id]="ind.name" [value]="ind.name" [disabled]="true" class="w-full" />
          </td>
          <td class="pt-4 pr-2">
            <input pInputText type="number" [(ngModel)]="targeted[ind.id]" />
          </td>
          <td class="pt-4 pr-2">
            <input pInputText type="number" [(ngModel)]="achieved[ind.id]" />
          </td>
        </tr>
        }
      </tbody>
    </table>
    <div class="flex justify-end">
      <p-button
        pButton
        size="small"
        [disabled]="addMetricsStore.isLoading()"
        [loading]="addMetricsStore.isLoading()"
        (click)="onSaveMetrics()">
        Enregistrer les valeurs
      </p-button>
    </div>
  </div>
  }
</section>
