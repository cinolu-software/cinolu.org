<section class="text-gray-700">
  @let isLoading = store.isLoading(); @let ventureCount = store.ventures()[1]; @let ventureList = store.ventures()[0];
  @let hasQuery = queryParams().q;

  <div class="relative bg-white rounded-lg pb-10 shadow-sm border border-gray-100">
    <div class="px-6 pt-6 flex flex-col gap-3 md:flex-row md:justify-between md:items-center">
      <h5 class="text-lg font-bold flex items-center gap-2">
        Liste des Entreprises
        <span class="text-gray-500 text-sm flex items-center gap-1">
          @if (isLoading) {
          <p-progress-spinner
            strokeWidth="5"
            animationDuration=".5s"
            fill="transparent"
            [style]="{ width: '0.8rem', height: '0.8rem' }" />
          } @else { [{{ ventureCount }}] }
        </span>
      </h5>
    </div>

    <form [formGroup]="searchForm" class="flex flex-wrap px-6 my-4 justify-between md:w-1/2">
      <span class="relative block">
        <input pInputText class="w-full pl-9 py-2" formControlName="q" placeholder="Rechercher une entreprise..." />
      </span>
      <p-select [options]="sectors" formControlName="q" placeholder="Secteur à sélectionner" class="w-full md:w-56" />
    </form>

    @if (ventureCount === 0 && !isLoading) {
    <h4 class="font-medium text-gray-700 text-lg px-6 pb-8">
      {{ hasQuery ? 'Aucun résultat pour ce filtre.' : 'Aucune entreprise trouvée.' }}
    </h4>
    } @if (isLoading) {
    <div class="grid grid-cols-5 mx-6 my-6 border border-gray-200 rounded-lg">
      @for (i of skeletonArray; track $index) {
      <div class="border-y border-gray-200 py-3 px-6">
        <div class="h-4 rounded-lg bg-gray-200 animate-pulse mb-2"></div>
      </div>
      }
    </div>
    } @if (ventureCount > 0 && !isLoading) {
    <div class="relative flex flex-col overflow-x-auto mx-6 my-6 border border-gray-200 rounded-lg">
      <table class="text-left text-gray-600 w-full">
        <thead class="bg-gray-100 text-gray-700 py-5 font-semibold uppercase text-sm">
          <tr class="py-2">
            <th class="px-5 py-4">#</th>
            <th class="px-5 py-4">Image</th>
            <th class="px-5 py-4">Nom</th>
            <th class="px-5 py-4">Statut</th>
            <th class="px-5 py-4">Création</th>
            <th class="px-5 py-4">Secteur</th>
            <th class="px-5 py-4 text-center">Actions</th>
          </tr>
        </thead>

        <tbody>
          @for (venture of ventureList | paginate : { itemsPerPage: 40, currentPage: queryParams().page || 1,
          totalItems: ventureCount }; track venture.id) {

          <tr
            class="border-b border-gray-200 hover:bg-gray-50 transition-colors cursor-pointer"
            [ngClass]="expandedMenu() === venture.id ? 'bg-gray-100 border border-primary-500/60' : ''"
            (click)="toggleExpand(venture.id)">
            <td class="px-5 py-2 text-sm" [class.text-primary-500]="expandedMenu() === venture.id">
              <i-lucide
                [name]="expandedMenu() === venture.id ? icons.chevronDown : icons.chevronRight"
                class="size-4 md:size-6 transition-transform duration-200" />
            </td>
            <td class="px-6 py-2">
              <p-avatar [image]="venture | apiIMG: 'venture'" shape="circle" size="large" />
            </td>
            <td class="px-5 py-2 font-semibold text-sm">{{ venture.name | titlecase }}</td>
            <td class="px-5 py-2 text-sm">{{ venture.is_published }}</td>
            <td class="px-5 py-2 text-sm">{{ venture.founded_at | date: 'shortDate' }}</td>
            <td class="px-5 py-2 text-sm">
              <span
                class="px-5 py-1.5 text-xs font-semibold rounded-lg text-white truncate inline-block max-w-[15ch]"
                [style.background]="sectorColor(venture.sector)">
                {{ venture.sector }}
              </span>
            </td>
            <td class="px-5 py-2 text-sm">
              <div class="flex justify-center items-center gap-2">
                <button type="submit" pButton outlined severity="danger" (click)="onDeleteVenture(venture.id, $event)">
                  <div class="relative">
                    <p-confirmpopup />
                    <i-lucide [name]="icons.eyeOpen" class="size-4" />
                  </div>
                </button>
                <a
                  pButton
                  outlined
                  severity="info"
                  [routerLink]="['/dashboard/entrepreneurs/ventures/edit', venture.slug]"
                  (click)="$event.stopPropagation()">
                  <i-lucide [name]="icons.edit" class="size-4" />
                </a>
                <button type="submit" pButton outlined severity="danger" (click)="onDeleteVenture(venture.id, $event)">
                  <div class="relative">
                    <p-confirmpopup />
                    <i-lucide [name]="icons.trash" class="size-4" />
                  </div>
                </button>
              </div>
            </td>
          </tr>

          @if (expandedMenu() === venture.id) {
          <tr class="bg-gray-50 border-b border-gray-200 animate-fadeIn">
            <td colspan="7" class="px-6 py-4 text-sm text-gray-700">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="flex flex-col gap-2">
                  <p class="font-semibold text-gray-800">Description :</p>
                  <p class="text-gray-600 hyphens-none">{{ venture.description || 'Aucune description' }}</p>
                </div>
                <div class="flex flex-col gap-2">
                  <div class="flex gap-2">
                    <p class="font-semibold text-gray-800">Localisation :</p>
                    <p>{{ venture.location || 'Non spécifiée' }}</p>
                  </div>
                  <div class="flex gap-2">
                    <p class="font-semibold text-gray-800">Responsable :</p>
                    <p>{{ venture.email }}</p>
                  </div>

                  <span
                    class="px-5 py-1.5 text-xs font-semibold rounded-lg text-white truncate inline-block w-fit"
                    [style.background]="sectorColor(venture.sector)">
                    {{ venture.sector }}
                  </span>
                </div>
              </div>
            </td>
          </tr>
          } }
        </tbody>
      </table>
    </div>

    } @if (ventureCount > 40) {
    <div class="flex justify-center items-center gap-3 py-8">
      <pagination-controls
        nextLabel=""
        previousLabel=""
        [autoHide]="true"
        [maxSize]="5"
        (pageChange)="onPageChange($event)"
        class="pg" />
    </div>
    }
  </div>
</section>
