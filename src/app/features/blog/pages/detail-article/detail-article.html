@let comments = commentsStore.comments()[0]; @let count = commentsStore.comments()[1]; @let user = profile.user(); @let
gallery = store.article()?.gallery || [];

<section
  class="min-h-[85vh] py-10 lg:py-32 px-6 md:px-16 xl:px-24 2xl:px-32 max-w-screen-2xl mx-auto flex flex-col lg:flex-row items-start gap-10">
  <div class="lg:w-2/3 w-full">
    @if (store.article(); as article) {
    <article class="bg-white rounded-lg duration-300 overflow-hidden max-sm:pt-12">
      <div class="relative">
        <div class="absolute top-6 right-6 z-10">
          <span
            class="inline-flex items-center px-3 py-1.5 bg-white/90 backdrop-blur-sm text-primary-600 text-sm font-semibold rounded-full shadow-sm border border-primary-200/60">
            Article
          </span>
        </div>

        <div class="relative h-64 md:h-96 w-full overflow-hidden">
          <img
            [ngSrc]="article | apiIMG: 'article'"
            alt="Photo de couverture de l'article {{ article.title }}"
            class="object-cover w-full h-full hover:scale-105 transition-transform duration-700"
            fill
            priority />
          <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent"></div>

          <div class="absolute bottom-0 left-0 right-0 p-6 md:p-8">
            <h1
              class="font-black font-satoshi text-2xl md:text-4xl lg:text-5xl text-white drop-shadow-2xl leading-tight">
              {{ article.title | titlecase }}
            </h1>
          </div>
        </div>
      </div>

      <div class="">
        <div
          class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8 p-4 bg-gray-50/80 rounded-lg border border-gray-100">
          <div class="flex items-center gap-3">
            <div
              class="w-10 h-10 bg-gradient-to-br from-primary-100 to-primary-200 rounded-full flex items-center justify-center">
              <span class="text-primary-700 font-bold text-sm">{{ article.author.name.charAt(0) }}</span>
            </div>
            <div>
              <p class="text-xs text-gray-500 uppercase tracking-wide">Publié par</p>
              <p class="font-semibold text-gray-900">{{ article.author.name }}</p>
            </div>
          </div>

          <div class="flex items-center gap-4 text-sm text-gray-500">
            <div class="flex items-center gap-1">
              <div class="w-2 h-2 bg-primary-400 rounded-full"></div>
              <span>{{ article.published_at | date: 'longDate' }}</span>
            </div>
            <div class="flex items-center gap-1">
              <div class="w-2 h-2 bg-green-400 rounded-full"></div>
              <span>{{ count }} commentaire{{ count > 1 ? 's' : '' }}</span>
            </div>
          </div>
        </div>

        <div class="flex flex-wrap gap-2 mb-8">
          @for (tag of article.tags; track $index) {
          <span
            class="inline-flex items-center px-3 py-1.5 bg-gradient-to-r from-primary-50 to-primary-100 text-sm font-semibold text-primary-700 rounded-full border border-primary-200/60 hover:from-primary-100 hover:to-primary-200 transition-all duration-200 cursor-pointer">
            {{ tag.name }}
          </span>
          }
        </div>

        <div
          class="mb-8 p-6 bg-gradient-to-r from-primary-50/50 to-secondary-50/50 rounded-lg border-l-4 border-primary-400">
          <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
            <div class="w-2 h-2 bg-primary-500 rounded-full"></div>
            Résumé
          </h2>
          <p class="text-gray-700 leading-relaxed">{{ article.summary }}</p>
        </div>

        <div class="prose prose-gray prose-lg max-w-none mb-10">
          <quill-view [content]="article.content" class="hyphens-none" />
        </div>

        <div class="border-t border-gray-200 pt-8">
          <form
            class="flex flex-col gap-4 bg-gradient-to-r from-gray-50 to-gray-100/80 rounded-lg p-6 border border-gray-200/60"
            [formGroup]="form"
            (ngSubmit)="onAddComment()">
            <div class="flex items-center gap-2 mb-2">
              <div class="w-2 h-2 bg-primary-500 rounded-full"></div>
              <label for="content" class="font-bold text-gray-800">Laissez un commentaire</label>
            </div>
            <textarea
              id="content"
              pTextarea
              pSize="small"
              fluid
              formControlName="content"
              rows="3"
              class="border-gray-300 focus:border-primary-500 focus:ring-primary-500/20 rounded-lg"
              placeholder="Partagez votre avis sur cet article..."></textarea>

            @if (!isLoggedIn()) {
            <div
              class="flex items-center gap-3 text-amber-700 bg-amber-50 border border-amber-200 text-sm p-3 rounded-lg">
              <div class="w-2 h-2 bg-amber-500 rounded-full flex-shrink-0"></div>
              <span>Vous devez vous connecter pour écrire un commentaire.</span>
            </div>
            }

            <input type="hidden" formControlName="articleId" />

            @if (isLoggedIn()) {
            <div class="flex justify-end">
              <p-button
                [loading]="storeAddComment.isLoading()"
                [disabled]="!isLoggedIn() || form.invalid || storeAddComment.isLoading()"
                size="small"
                type="submit"
                class="bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700">
                Publier le commentaire
              </p-button>
            </div>
            }
          </form>

          @if (count > 0) {
          <div class="mt-10">
            <div class="flex items-center gap-3 mb-8">
              <div class="w-2 h-2 bg-primary-500 rounded-full"></div>
              <h3 class="text-xl font-bold text-gray-800">Commentaires ({{ count }})</h3>
            </div>

            <div class="space-y-6">
              @for (comment of comments; track $index) {
              <div class="bg-white border border-gray-100 rounded-lg p-6 transition-colors duration-200">
                <div class="flex gap-4">
                  <div class="flex-shrink-0">
                    <div
                      class="relative h-12 w-12 rounded-full overflow-hidden bg-gradient-to-br from-primary-500 to-pink-400 flex items-center justify-center text-white font-bold">
                      @if (comment.author; as a) {
                      <img
                        [ngSrc]="a | apiIMG: 'user'"
                        alt="Avatar de {{ a.name }}"
                        class="object-cover w-full h-full"
                        loading="lazy"
                        fill
                        priority />
                      }
                    </div>
                  </div>

                  <div class="flex-1 min-w-0">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3">
                      <h4 class="font-semibold text-gray-900">{{ comment?.author?.name }}</h4>
                      <time class="text-sm text-gray-500">{{ comment.created_at | date: 'fullDate' }}</time>
                    </div>

                    <p class="text-gray-700 leading-relaxed break-words mb-4">{{ comment.content }}</p>

                    @if (comment.author.id === user?.id) {
                    <div class="flex gap-2 justify-end">
                      <button
                        class="inline-flex items-center justify-center w-8 h-8 text-primary-600 bg-primary-50 hover:bg-primary-100 rounded-full transition-colors duration-200"
                        (click)="onToggleEditModal(comment)"
                        aria-label="Modifier le commentaire">
                        <i-lucide [name]="icons.edit" class="size-4" />
                      </button>
                      <button
                        class="inline-flex items-center justify-center w-8 h-8 text-red-600 bg-red-50 hover:bg-red-100 rounded-full transition-colors duration-200"
                        (click)="onDeleteComment(comment.id, $event)"
                        aria-label="Supprimer le commentaire">
                        <i-lucide [name]="icons.delete" class="size-4" />
                      </button>
                    </div>
                    }
                  </div>
                </div>
              </div>
              } @if (comments.length < count) {
              <div class="flex justify-center pt-4">
                <p-button
                  size="small"
                  outlined
                  severity="primary"
                  (click)="loadMore()"
                  class="border-2 border-primary-200 hover:border-primary-300">
                  Charger plus de commentaires
                </p-button>
              </div>
              }
            </div>
          </div>
          }
        </div>
      </div>
    </article>

    } @if (store.isLoading()) {
    <app-article-card-skeleton />
    } @if (!store.isLoading() && !store.article()) {
    <div class="min-h-[75vh] w-full flex flex-col justify-center items-center text-center">
      <div class="max-w-md mx-auto">
        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
          <i-lucide name="file-x" class="size-10 text-gray-400" />
        </div>
        <h2 class="text-3xl font-bold text-gray-800 mb-3">Article introuvable</h2>
        <p class="text-gray-600 mb-6">
          Cet article n'existe pas ou a été supprimé. Vérifiez le lien ou explorez nos autres articles.
        </p>
        <p-button
          routerLink="/blog-ressources"
          severity="primary"
          class="bg-gradient-to-r from-primary-500 to-primary-600">
          Voir tous les articles
        </p-button>
      </div>
    </div>
    }
  </div>

  <div class="lg:w-1/3 w-full lg:sticky lg:top-24 lg:self-start">
    <div class="bg-white rounded-lg border border-gray-200/60 shadow-sm p-6 mb-8">
      <div class="flex items-center gap-2 mb-6">
        <div class="w-2 h-2 bg-primary-500 rounded-full"></div>
        <h2 class="font-black font-satoshi text-2xl text-gray-800">Derniers articles</h2>
      </div>

      <div class="space-y-4">
        @for (article of storeArticle.articles(); track $index) {
        <a [routerLink]="['/blog-ressources', article.slug]" class="group block">
          <div
            class="flex gap-4 items-start w-full bg-gray-50/80 hover:bg-primary-50/50 rounded-lg overflow-hidden border border-gray-100 hover:border-primary-200/60 transition-all duration-200">
            <div class="relative h-20 w-20 flex-shrink-0 bg-gray-100">
              <img
                [ngSrc]="article | apiIMG: 'article'"
                alt="Miniature de l'article {{ article.title }}"
                class="object-cover w-full h-full"
                fill
                priority />
            </div>
            <div class="flex flex-col justify-between p-3 flex-1 min-w-0">
              <h3
                class="font-bold font-satoshi text-sm line-clamp-2 group-hover:text-primary-600 transition-colors duration-200 leading-tight">
                {{ article.title | titlecase }}
              </h3>
              <p class="text-xs text-gray-500 line-clamp-1 mt-1">{{ article.summary }}</p>
            </div>
          </div>
        </a>
        }
      </div>
    </div>

    <div class="bg-white rounded-lg border border-gray-200/60 shadow-sm p-6">
      <div class="flex items-center gap-2 mb-6">
        <div class="w-2 h-2 bg-secondary-500 rounded-full"></div>
        <h3 class="font-bold text-xl text-gray-800">Galerie</h3>
      </div>

      @if (gallery.length > 0) {
      <p-galleria
        [value]="gallery"
        [autoPlay]="true"
        [circular]="true"
        [responsiveOptions]="responsiveOptions"
        [numVisible]="5"
        [containerStyle]="{ 'max-width': '640px' }">
        <ng-template pTemplate="item" let-img>
          <div class="relative w-full overflow-hidden h-64 md:h-80 rounded-lg">
            <img
              [src]="img | apiIMG:'gallery'"
              alt="{{img.image}}"
              fill
              priority
              class="object-cover w-full h-full transition-transform duration-300 hover:scale-105" />
          </div>
        </ng-template>

        <ng-template pTemplate="thumbnail" let-img class="cursor-pointer gap-2">
          <img
            [src]="img | apiIMG:'gallery'"
            alt="{{img.image}}"
            fill
            priority
            class="object-cover p-1 h-16 w-16 rounded-lg border border-gray-200" />
        </ng-template>
      </p-galleria>
      } @else {
      <div class="relative w-full overflow-hidden h-64 md:h-80 rounded-lg">
        <img
          fill
          priority
          [src]="gallery | apiIMG:'ventureCover'"
          alt="{{gallery?.[0]?.image}}"
          class="object-cover w-full h-full transition-transform duration-300 hover:scale-105" />
      </div>
      }
    </div>
  </div>
</section>

<p-dialog
  [(visible)]="showEditModal"
  [closable]="false"
  [modal]="true"
  [style]="{ width: '28rem' }"
  styleClass="rounded-lg">
  <div class="p-6">
    <div class="flex items-center gap-2 mb-6">
      <div class="w-2 h-2 bg-primary-500 rounded-full"></div>
      <h3 class="text-xl font-bold text-gray-800">Modifier le commentaire</h3>
    </div>

    <form [formGroup]="updateCommentForm" class="space-y-4" (ngSubmit)="onUpdateComment()">
      <div>
        <label for="content" class="block text-sm font-semibold text-gray-700 mb-2">
          Contenu<span class="text-red-500 ml-1">*</span>
        </label>
        <textarea
          pTextarea
          id="content"
          formControlName="content"
          rows="5"
          class="w-full border-gray-300 focus:border-primary-500 focus:ring-primary-500/20 rounded-lg"
          placeholder="Modifiez votre commentaire..."></textarea>
      </div>

      <div class="flex justify-end gap-3 pt-4">
        <p-button
          size="small"
          variant="outlined"
          severity="secondary"
          class="font-satoshi border-gray-300 text-gray-700 hover:bg-gray-50"
          (onClick)="closeModal()">
          Annuler
        </p-button>
        <p-button
          size="small"
          severity="primary"
          class="font-satoshi bg-gradient-to-r from-primary-500 to-primary-600"
          (onClick)="onUpdateComment()">
          Mettre à jour
        </p-button>
      </div>
    </form>
  </div>
</p-dialog>

<p-confirmdialog />
