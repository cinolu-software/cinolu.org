@let comments = commentsStore.comments()[0]; @let count = commentsStore.comments()[1]; @let user = profile.user();

<section
  class="min-h-[85vh] py-10 lg:py-32 px-6 md:px-16 xl:px-24 2xl:px-32 max-w-screen-2xl mx-auto flex flex-col lg:flex-row gap-10">
  <div class="lg:w-2/3 w-full">
    @if (store.article(); as article) {
    <div class="p-6 md:p-8">
      <h1 class="font-black font-satoshi mb-4 text-2xl md:text-3xl text-gray-900">{{ article.title | titlecase }}</h1>

      <div class="relative h-60 md:h-96 w-full overflow-hidden">
        <img
          [ngSrc]="article | apiIMG: 'article'"
          alt="Photo de couverture de l’article {{ article.title }}"
          class="object-cover w-full h-full"
          fill
          priority />
      </div>

      <div class="my-10">
        <div
          class="flex flex-wrap justify-between items-center pb-4 border-b border-gray-200 text-sm text-gray-600 gap-3">
          <p>
            Publié par :
            <strong>{{ article.author.name }}</strong>
          </p>
          <div class="flex flex-wrap items-center gap-2">
            @for (tag of article.tags; track $index) {
            <span
              class="text-sm border border-primary-500/20 bg-primary-500/10 hover:bg-primary-500/5 text-primary-500 rounded-full px-3 py-1 transition-transform duration-300 hover:scale-105 cursor-pointer">
              {{ tag.name }}
            </span>
            }
          </div>
        </div>

        <div class="flex items-center gap-3 my-8">
          <div class="flex-1 border-t border-gray-300"></div>
          <span class="px-3 text-gray-700 font-semibold">Résumé</span>
          <div class="flex-1 border-t border-gray-300"></div>
        </div>

        <p class="mb-6 text-gray-700 text-justify leading-relaxed">{{ article.summary }}</p>

        <div class="flex flex-col lg:flex-row justify-between text-sm text-gray-600 border-b pb-4 border-gray-200">
          <p>
            Publié le :
            <strong>{{ article.published_at | date: 'longDate' }}</strong>
          </p>
          <p>
            Commentaires :
            <strong>{{ count }}</strong>
          </p>
        </div>

        <div class="prose prose-gray max-w-none mt-8">
          <quill-view [content]="article.content" class="hyphens-none text-base" />
        </div>

        <form
          class="mt-10 flex flex-col gap-4 bg-gray-50 rounded-lg p-5"
          [formGroup]="form"
          (ngSubmit)="onAddComment()">
          <label for="content" class="font-semibold text-gray-700">Saisissez un commentaire</label>
          <textarea id="content" pTextarea pSize="small" fluid formControlName="content" rows="3"></textarea>

          @if (!isLoggedIn()) {
          <div class="text-red-500 bg-red-100 text-sm p-2 rounded-lg">
            Vous devez vous connecter pour écrire un commentaire.
          </div>
          }

          <input type="hidden" formControlName="articleId" />

          @if (isLoggedIn()) {
          <div class="flex justify-end">
            <p-button
              [loading]="storeAddComment.isLoading()"
              [disabled]="!isLoggedIn() || form.invalid || storeAddComment.isLoading()"
              size="small"
              type="submit">
              Ajouter un commentaire
            </p-button>
          </div>
          }
        </form>

        @if (count > 0) {
        <div class="flex items-center gap-3 my-10">
          <div class="flex-1 border-t border-gray-300"></div>
          <span class="px-3 text-gray-700 font-semibold">Commentaires</span>
          <div class="flex-1 border-t border-gray-300"></div>
        </div>

        <div class="flex flex-col gap-4 mt-6 divide-y divide-gray-100">
          @for (comment of comments; track $index) {
          <div class="bg-white rounded-xl p-4 flex flex-col gap-3 md:flex-row md:gap-5 hover:shadow-xs transition">
            <div
              class="relative h-12 w-12 rounded-full overflow-hidden bg-gradient-to-br from-primary-500 to-pink-400 flex items-center justify-center text-white font-bold flex-shrink-0">
              @if (comment.author; as a) {
              <img
                [ngSrc]="a | apiIMG: 'user'"
                alt="Avatar de {{ a.name }}"
                class="object-cover w-full h-full"
                loading="lazy"
                fill />
              }
            </div>

            <div class="flex-1 flex flex-col gap-2">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                <span class="font-medium text-gray-800">{{ comment?.author?.name }}</span>
                <span class="text-xs text-gray-400">{{ comment.created_at | date: 'fullDate' }}</span>
              </div>

              <p class="text-gray-700 leading-relaxed break-words">{{ comment.content }}</p>

              @if (comment.author.id === user?.id) {
              <div class="flex gap-2 justify-end">
                <button
                  class="text-primary-500 h-8 w-8 bg-primary-500/10 rounded-full flex items-center justify-center transition hover:bg-primary-500 hover:text-white"
                  (click)="onToggleEditModal(comment)"
                  aria-label="Modifier le commentaire">
                  <i-lucide [name]="icons.edit" class="size-4" />
                </button>
                <button
                  class="text-red-500 h-8 w-8 bg-red-500/10 rounded-full flex items-center justify-center transition hover:bg-red-500 hover:text-white"
                  (click)="onDeleteComment(comment.id, $event)"
                  aria-label="Supprimer le commentaire">
                  <i-lucide [name]="icons.delete" class="size-4" />
                </button>
              </div>
              }
            </div>
          </div>
          } @if (comments.length < count) {
          <div class="flex justify-center mt-4">
            <p-button size="small" outlined severity="primary" (click)="loadMore()">Charger plus</p-button>
          </div>
          }
        </div>
        }
      </div>
    </div>

    } @if (store.isLoading()) {
    <app-article-card-skeleton />
    } @if (!store.isLoading() && !store.article()) {
    <div class="min-h-[75vh] w-full flex flex-col justify-center items-center text-center">
      <h2 class="text-3xl font-semibold mb-2">Aucun article trouvé</h2>
      <p class="text-gray-600">Essayez de recharger la page ou de vérifier le lien.</p>
    </div>
    }
  </div>

  <div class="lg:w-1/3 w-full h-auto">
    <div class="sticky top-10">
      <h2 class="font-black font-satoshi mb-4 text-2xl lg:text-3xl">Derniers articles</h2>
      <div class="flex flex-col gap-6">
        @for (article of storeArticle.articles(); track $index) {
        <a [routerLink]="['/blog-ressources', article.slug]" class="group">
          <div
            class="flex gap-3 items-start w-full bg-gray-50 rounded-lg overflow-hidden group-hover:shadow-md transition cursor-pointer group-hover:-translate-y-1">
            <div class="relative h-28 w-28 flex-shrink-0 bg-gray-100">
              <img
                [ngSrc]="article | apiIMG: 'article'"
                alt="Miniature de l’article {{ article.title }}"
                class="object-cover w-full h-full"
                fill />
            </div>
            <div class="flex flex-col justify-between p-3 w-full">
              <h3 class="font-bold font-satoshi text-base line-clamp-1 group-hover:text-primary-500 transition">
                {{ article.title | titlecase }}
              </h3>
              <p class="text-sm text-gray-600 line-clamp-2 mt-2">{{ article.summary }}</p>
            </div>
          </div>
        </a>

        }
      </div>
    </div>
  </div>
</section>

<p-dialog [(visible)]="showEditModal" [closable]="false" [modal]="true" [style]="{ width: '25rem' }">
  <form [formGroup]="updateCommentForm" class="flex flex-col gap-4" (ngSubmit)="onUpdateComment()">
    <div class="flex flex-col gap-2">
      <label for="content" class="font-medium">Contenu<span class="text-red-500">*</span></label>
      <textarea pTextarea id="content" formControlName="content" rows="5"></textarea>
    </div>
    <div class="flex justify-end gap-4 flex-wrap">
      <p-button size="small" variant="outlined" severity="danger" class="font-satoshi" (onClick)="closeModal()">
        Annuler
      </p-button>
      <p-button size="small" severity="primary" class="font-satoshi" (onClick)="onUpdateComment()">
        Mettre à jour
      </p-button>
    </div>
  </form>
</p-dialog>

<p-confirmdialog />
