<section class="px-8 lg:px-16 xl:px-24 2xl:px-32 max-w-screen-2xl mx-auto bg-white pt-[7.5rem] pb-20">
  @if (store.project(); as project) {

  <div class="space-y-16">
    <header class="text-center">
      <h1 class="font-black font-satoshi text-4xl md:text-6xl text-gray-900 leading-tight tracking-tight">
        {{ project.name | titlecase }}
      </h1>
      <p class="text-lg text-gray-500 mt-2">{{ 'project_detail.detail.subtitle' | translate }}</p>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-12 lg:gap-20">
      <aside class="md:sticky top-28 self-start z-10 md:top-28">
        @if (project.gallery && project.gallery.length > 0) {
        <p-galleria
          [value]="project.gallery"
          [autoPlay]="true"
          [circular]="true"
          [responsiveOptions]="responsiveOptions"
          [numVisible]="5"
          [containerStyle]="{ 'max-width': '640px' }"
          class="rounded-lg shadow-2xl bg-white">
          <ng-template pTemplate="item" let-img>
            <figure class="relative h-80 md:h-[30rem] w-full rounded-md overflow-hidden shadow-xl group">
              <img
                [src]="img | apiIMG: 'gallery'"
                [alt]="img.image || project.name || 'gallery image'"
                class="object-cover w-full h-full transition-transform duration-700 group-hover:scale-[1.03]"
                loading="lazy"
                fill />
              <span
                class="absolute inset-0 bg-black/10 opacity-0 group-hover:opacity-100 transition duration-500"
                aria-hidden="true"></span>
            </figure>
          </ng-template>

          <ng-template pTemplate="thumbnail" let-img>
            <img
              [src]="img | apiIMG: 'gallery'"
              [alt]="img.image || 'thumbnail'"
              class="object-cover h-20 w-20 rounded-md shadow-sm hover:ring-2 ring-primary-400 transition transform hover:scale-105"
              loading="lazy" />
          </ng-template>
        </p-galleria>
        } @else {
        <figure
          class="relative w-full overflow-hidden h-80 md:h-[34rem] rounded-md shadow-2xl bg-gray-100 transition-transform hover:scale-105">
          <img
            [src]="project | apiIMG: 'project'"
            [alt]="project.name"
            class="object-cover w-full h-full"
            loading="lazy" />
        </figure>
        }
      </aside>

      <div class="flex flex-col gap-10">
        <div class="bg-white rounded-md shadow-xl border border-gray-50 overflow-hidden hover:shadow-2xl transition">
          <div class="p-6">
            <div class="mb-6 flex items-center justify-between">
              <div class="flex items-center gap-4">
                <div
                  class="flex items-center justify-center w-12 h-12 rounded-full bg-gradient-to-br from-primary-500 to-primary-600 text-white shadow-lg">
                  <i-lucide [name]="icons.fileText" class="size-6"></i-lucide>
                </div>
                <h2 class="text-2xl md:text-3xl font-bold text-gray-900">
                  {{ 'project_detail.detail.description' | translate }}
                </h2>
              </div>

              <button
                type="button"
                class="w-10 h-10 rounded-full border border-gray-200 flex items-center justify-center text-gray-500 hover:bg-gray-100 transition"
                (click)="toggleDescription()"
                [attr.aria-expanded]="expandedDescription()"
                aria-controls="project-description">
                <i-lucide
                  [name]="icons.chevronUp"
                  class="size-5 transition-transform"
                  [ngClass]="expandedDescription() ? 'rotate-180 text-primary-600' : 'text-gray-500'" />
              </button>
            </div>

            <p
              id="project-description"
              class="text-gray-700 leading-relaxed transition-all duration-500 overflow-hidden text-base md:text-lg"
              [ngClass]="expandedDescription()
                ? 'max-h-[500px] opacity-100 bg-primary-50/50 rounded-lg p-4 border border-primary-100'
                : 'max-h-[4.5em] opacity-90 line-clamp-3'">
              {{ project.description || ('project_detail.detail.empty' | translate) }}
            </p>
          </div>
        </div>

        <div class="bg-white rounded-md shadow-xl border border-gray-50 overflow-hidden hover:shadow-2xl transition">
          <div class="p-6">
            <div class="mb-6 flex items-center justify-between">
              <div class="flex items-center gap-4">
                <div
                  class="flex items-center justify-center w-12 h-12 rounded-full bg-gradient-to-br from-primary-500 to-primary-600 text-white shadow-lg">
                  <i-lucide [name]="icons.checkCircle2" class="size-6"></i-lucide>
                </div>
                <h2 class="font-semibold text-lg md:text-xl text-gray-700">
                  {{ 'project_detail.detail.selection_criteria' | translate }}
                </h2>
              </div>

              <button
                type="button"
                class="w-10 h-10 rounded-full text-gray-500 flex items-center justify-center hover:bg-gray-100 border border-gray-200 transition"
                (click)="toggleCriteria()"
                [attr.aria-expanded]="expandedCriteria()"
                aria-controls="criteria-description">
                <i-lucide
                  [name]="icons.chevronUp"
                  class="size-5 transition-transform"
                  [ngClass]="expandedCriteria() ? 'rotate-180 text-primary-600' : 'text-gray-500'" />
              </button>
            </div>

            <p
              id="criteria-description"
              class="text-gray-700 leading-relaxed transition-all duration-500 overflow-hidden text-sm md:text-base"
              [ngClass]="expandedCriteria()
                ? 'max-h-[500px] opacity-100 bg-primary-50/50 rounded-lg p-4 border border-primary-100'
                : 'max-h-[4.5em] opacity-90 line-clamp-3'">
              {{ project.selection_criteria || ('project_detail.detail.empty' | translate) }}
            </p>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <article class="bg-white rounded-md shadow-lg p-6 border border-gray-100 hover:shadow-2xl transition">
            <div class="flex items-center gap-3 mb-4">
              <div class="w-9 h-9 bg-primary-50 text-primary-600 flex items-center justify-center rounded-full">
                <i-lucide [name]="icons.target" class="size-5"></i-lucide>
              </div>
              <h3 class="font-semibold text-lg text-gray-800">{{ 'project_detail.detail.objectives' | translate }}</h3>
            </div>
            <p class="text-sm md:text-base text-gray-600">
              {{ project.objectives || ('project_detail.detail.empty' | translate) }}
            </p>
          </article>

          <article class="bg-white rounded-md shadow-lg p-6 border border-gray-100 hover:shadow-2xl transition">
            <div class="flex items-center gap-3 mb-4">
              <div class="w-9 h-9 bg-primary-50 text-primary-600 flex items-center justify-center rounded-full">
                <i-lucide [name]="icons.info" class="size-5"></i-lucide>
              </div>
              <h3 class="font-semibold text-lg text-gray-700">{{ 'project_detail.detail.context' | translate }}</h3>
            </div>
            <p class="text-sm md:text-base text-gray-600">
              {{ project.context || ('project_detail.detail.empty' | translate) }}
            </p>
          </article>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="bg-white rounded-md shadow-lg p-6 border border-gray-100 hover:shadow-2xl transition">
            <div class="flex items-center gap-3 mb-4">
              <div class="w-9 h-9 bg-primary-50 text-primary-600 flex items-center justify-center rounded-full">
                <i-lucide [name]="icons.hourglass" class="size-5"></i-lucide>
              </div>
              <h4 class="font-semibold text-lg text-gray-800">{{ 'project_detail.detail.duration' | translate }}</h4>
            </div>
            <p class="text-sm md:text-base text-gray-600">
              {{ project.duration_hours || ('project_detail.detail.empty' | translate) }} {{
              'project_detail.detail.duration_hours' | translate }}
            </p>
          </div>
          <div class="bg-white rounded-md shadow-lg p-6 border border-gray-100 hover:shadow-2xl transition">
            <div class="flex items-center gap-3 mb-4">
              <div class="w-9 h-9 bg-primary-50 text-primary-600 flex items-center justify-center rounded-full">
                <i-lucide [name]="icons.users" class="size-5"></i-lucide>
              </div>
              <h4 class="font-semibold text-lg text-gray-800">
                {{ 'project_detail.detail.participants' | translate }}
              </h4>
            </div>

            <div class="flex flex-wrap gap-2">
              @if (project.participants && project.participants.length > 0) { @for (participant of project.participants;
              track $index) {
              <span
                class="px-3 py-1 rounded-full bg-primary-50 border border-primary-200 text-gray-700 text-sm hover:bg-primary-100 transition transform hover:scale-105"
                >{{ participant.name }}</span
              >
              } } @else {
              <span class="text-gray-500 text-sm italic">{{ 'project_detail.detail.no_participant' | translate }}</span>
              }
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 gap-6">
          <div class="bg-white rounded-lg shadow-xl border border-gray-100 p-6 hover:shadow-2xl transition">
            <div class="flex items-center gap-3 mb-6">
              <div class="w-9 h-9 bg-primary-50 text-primary-600 flex items-center justify-center rounded-full">
                <i-lucide [name]="icons.calendarDays" class="size-5"></i-lucide>
              </div>
              <h4 class="font-semibold text-lg text-gray-800">{{ 'project_detail.detail.dates' | translate }}</h4>
            </div>

            <dl class="space-y-4">
              <div class="flex items-center justify-between p-3 rounded-lg bg-gray-50 hover:bg-gray-100 transition">
                <dt class="font-medium text-gray-900 flex items-center gap-3">
                  <i-lucide class="size-5 text-primary-500" [name]="icons.calendarDays"></i-lucide>
                  {{ 'project_detail.detail.start' | translate }}
                </dt>
                <dd class="font-semibold text-gray-800">
                  {{ project.started_at ? (project.started_at | date: 'longDate') : ('project_detail.detail.empty' |
                  translate) }}
                </dd>
              </div>

              <div class="flex items-center justify-between p-3 rounded-lg bg-gray-50 hover:bg-gray-100 transition">
                <dt class="font-medium text-gray-900 flex items-center gap-3">
                  <i-lucide class="size-5 text-red-500" [name]="icons.calendarCheck"></i-lucide>
                  {{ 'project_detail.detail.end' | translate }}
                </dt>
                <dd class="font-semibold text-gray-800">
                  {{ project.ended_at ? (project.ended_at | date: 'longDate') : ('project_detail.detail.empty' |
                  translate) }}
                </dd>
              </div>
            </dl>
          </div>
        </div>

        @if (project.categories && project.categories.length > 0) {
        <div class="bg-white rounded-md p-6 shadow-xl border border-primary-200/50 hover:shadow-2xl transition">
          <div class="flex items-start gap-4 mb-6">
            <div class="w-12 h-12 bg-primary-50 text-primary-600 flex items-center justify-center rounded-full">
              <i-lucide [name]="icons.tag" class="size-6"></i-lucide>
            </div>
            <div>
              <h3 class="text-gray-700 text-lg md:text-xl font-bold mb-1">
                {{ 'project_detail.detail.categories' | translate }}
              </h3>
              <p class="text-sm text-gray-600">
                {{ project.categories.length }} {{ 'project_detail.detail.categories_label' | translate }}
              </p>
            </div>
          </div>

          <div class="flex flex-wrap gap-3">
            @for (cat of project.categories; track $index) {
            <span
              class="px-4 py-2 rounded-full bg-white border border-primary-300/80 text-sm text-gray-800 font-medium hover:bg-primary-50 transition transform hover:scale-105"
              >{{ cat.name || ('project_detail.detail.empty' | translate) }}</span
            >
            }
          </div>
        </div>
        }

        <div
          class="w-full rounded-lg p-6 md:p-8 bg-white border border-primary-200/50 shadow-2xl hover:shadow-2xl transition">
          <div class="flex flex-col justify-between gap-6">
            <div class="flex items-start gap-4">
              <div class="w-12 h-12 bg-primary-50 text-primary-600 flex items-center justify-center rounded-full">
                <i-lucide [name]="icons.squaresSubtract" class="size-6"></i-lucide>
              </div>
              <h3 class="text-gray-700 text-lg md:text-xl font-bold mb-1">
                {{ 'project_detail.detail.actions_status' | translate }}
              </h3>
            </div>

            <div class="flex flex-col sm:flex-row items-center justify-between gap-3 flex-wrap">
              <span
                class="inline-flex items-center gap-2 px-4 py-2 rounded-full border text-sm font-bold tracking-wider transition"
                [ngClass]="getStatusBadgeClasses(project)">
                {{ getStatut(project) }}
              </span>

              <button
                type="button"
                class="flex items-center gap-2 px-5 py-2.5 rounded-lg bg-primary-600 text-white shadow-md hover:bg-primary-700 transition duration-150 disabled:bg-gray-400"
                (click)="addToCalendar()"
                [disabled]="getStatut(project) === 'Terminé'">
                <i-lucide class="size-5" [name]="icons.calendarSync"></i-lucide>
                <span class="text-sm font-semibold">{{ 'project_detail.detail.add_to_calendar' | translate }}</span>
              </button>

              <button
                type="button"
                class="p-3 rounded-full border border-gray-300 text-gray-500 hover:bg-gray-100 transition duration-150"
                (click)="shareProject()">
                <i-lucide class="size-4" [name]="icons.share"></i-lucide>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="pt-8">
      <div class="flex items-center flex-col md:flex-row gap-4 md:gap-8 mb-12">
        <div
          class="w-16 h-16 rounded-full bg-gradient-to-br from-primary-400 to-primary-600 flex items-center justify-center shadow-2xl">
          <i-lucide [name]="icons.notepadText" class="size-10 text-white"></i-lucide>
        </div>
        <div>
          <h2 class="text-4xl font-extrabold text-gray-900 mb-2">{{ 'project_detail.detail.phases' | translate }}</h2>
          <p class="text-gray-600 text-lg">{{ 'project_detail.detail.phases_subtitle' | translate }}</p>
        </div>
      </div>

      @if (phasesLoading()) {
      <div class="text-gray-500 italic p-6 border rounded-lg bg-gray-50">{{ 'common.loading' | translate }}</div>
      } @else if (phases().length === 0) {
      <div class="text-gray-500 italic p-6 border rounded-lg bg-gray-50">
        {{ 'project_detail.detail.no_phase' | translate }}
      </div>
      } @else {
      <div class="relative">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 md:gap-8 lg:gap-10">
          @for (phase of phases(); track $index) {
          <div class="relative group">
            <div
              class="bg-white rounded-lg shadow-xl border border-primary-200/50 p-5 sm:p-7 md:p-8 transition hover:shadow-2xl hover:-translate-y-1 flex flex-col h-full">
              <div class="flex items-center gap-3 mb-4">
                <div
                  class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-primary-100 text-primary-600 flex items-center justify-center shadow-md flex-shrink-0">
                  <i-lucide [name]="icons.notepadText" class="size-6 sm:size-7"></i-lucide>
                </div>
                <h3 class="text-lg sm:text-2xl font-bold text-gray-900 line-clamp-1">{{ phase.name }}</h3>
                <span
                  class="ml-auto px-2 py-1 sm:px-3 sm:py-1 rounded-full text-xs font-semibold flex-shrink-0"
                  [ngClass]="phase.is_active ? 'bg-primary-100 text-primary-700' : 'bg-gray-100 text-gray-600'"
                  >{{ phase.is_active ? 'ACTIVE' : 'INACTIVE' }}</span
                >
              </div>

              <div class="flex flex-wrap gap-2 sm:gap-3 mb-4">
                <span
                  class="px-2 py-1 sm:px-3 sm:py-1 rounded-full bg-gray-100 text-gray-700 text-xs flex gap-2 items-center">
                  <i-lucide [name]="icons.calendarDays" class="size-4 text-primary-500"></i-lucide>
                  {{ phase.started_at | date: 'shortDate' }} – {{ phase.ended_at | date: 'shortDate' }}
                </span>

                <span
                  class="px-2 py-1 sm:px-3 sm:py-1 rounded-full bg-blue-50 text-blue-700 text-xs flex gap-2 items-center">
                  <i-lucide [name]="icons.users" class="size-4 text-blue-500"></i-lucide>
                  {{ getResourcesForPhase(phase.id).length }} {{ 'project_detail.detail.resources_label' | translate }}
                </span>
              </div>

              <p class="text-gray-700 mb-4 leading-relaxed line-clamp-3 text-sm sm:text-base">
                {{ phase.description }}
              </p>

              <div class="mt-auto border-t pt-4 border-gray-100">
                <h4 class="text-base sm:text-lg font-semibold text-primary-700 mb-3 flex items-center gap-2">
                  <i-lucide [name]="icons.fileText" class="size-5 text-primary-400"></i-lucide>{{
                  'project_detail.detail.resources' | translate }}
                </h4>
                <button
                  type="button"
                  class="mb-3 px-4 py-2 rounded-lg bg-primary-50 text-primary-700 border border-primary-200 hover:bg-primary-100 transition font-semibold text-sm flex items-center gap-2"
                  (click)="openResourcesDialog(phase.id)"
                  [attr.aria-expanded]="showResourcesDialog()">
                  <i-lucide
                    [name]="icons.chevronUp"
                    class="size-4"
                    [ngClass]="isResourcesExpanded(phase.id) ? 'rotate-180' : ''"></i-lucide>
                  {{ isResourcesExpanded(phase.id) ? ('project_detail.detail.hide_resources' | translate) :
                  ('project_detail.detail.show_resources' | translate) }}
                </button>

                @if (isResourcesExpanded(phase.id)) { @if (resourcesLoading()) {
                <div class="text-gray-400 italic">{{ 'common.loading' | translate }}</div>
                } @else { @if (getResourcesForPhase(phase.id).length === 0) {
                <div class="text-gray-400 italic">{{ 'project_detail.detail.no_resource' | translate }}</div>
                } @else {
                <ul class="space-y-2 sm:space-y-3">
                  @for (resource of getResourcesForPhase(phase.id); track $index) {
                  <li
                    class="flex items-center justify-between gap-2 sm:gap-3 bg-white border border-gray-200 rounded-lg px-3 py-2 sm:px-4 sm:py-3 shadow-sm hover:bg-gray-50 hover:shadow-md transition cursor-pointer transform hover:scale-105">
                    <div class="flex items-center gap-2 sm:gap-3">
                      <span
                        class="w-6 h-6 sm:w-7 sm:h-7 rounded-full bg-primary-100 text-primary-600 flex items-center justify-center flex-shrink-0">
                        <i-lucide [name]="icons.fileText" class="size-4"></i-lucide>
                      </span>
                      <span class="font-semibold text-gray-900 line-clamp-1 text-xs sm:text-sm"
                        >{{ resource.title }}</span
                      >
                    </div>
                    <span
                      class="px-2 py-1 max-w-[ch] rounded-full bg-primary-100 text-primary-700 text-xs font-medium flex-shrink-0"
                      >{{ resource.type }}</span
                    >
                    <div class="flex items-center gap-2">
                      @if (resource.type === 'LINK') {
                      <a
                        [href]="resource.url"
                        target="_blank"
                        rel="noopener"
                        class="inline-flex items-center gap-2 px-3 py-1 rounded-md border border-gray-200 text-sm bg-white hover:bg-gray-50"
                        >{{ 'project_detail.detail.open_link' | translate }}</a
                      >
                      } @else if (resource.type === 'PDF' || resource.type === 'OTHER') {

                      <a
                        [href]="getResourceUrl(resource)"
                        target="_blank"
                        rel="noopener noreferrer"
                        class="inline-flex items-center gap-1.5 text-xs text-primary-600 hover:text-primary-700 font-medium hover:underline transition-colors duration-200">
                        <span>Voir la ressource</span>
                        <i-lucide [name]="icons.external" class="size-3" />
                      </a>

                      } @else if (resource.type === 'IMAGE') {
                      <a [href]="resource.url" target="_blank" rel="noopener">
                        <img [src]="resource.url" alt="{{ resource.title }}" class="h-8 w-8 rounded shadow border" />
                      </a>
                      }
                    </div>
                  </li>
                  }
                </ul>
                } } @if (getFormsForPhase(phase.id).length > 0) {
                <div class="flex gap-2 flex-wrap justify-center mt-6">
                  @for (form of getFormsForPhase(phase.id); track $index) {
                  <p-button
                    (click)="openFormDialog(form)"
                    styleClass="inline-flex items-center gap-2 px-3 py-2 rounded-md bg-primary-50 text-primary-700 border border-primary-200 hover:bg-primary-100 text-sm font-semibold">
                    {{$index + 1}}. {{ form.title }}
                    <i-lucide [name]="icons.arrow"></i-lucide>
                  </p-button>
                  }
                </div>
                } }
              </div>
            </div>
          </div>
          }
        </div>
      </div>
      }
    </div>
  </div>
  } @if (store.isLoading()) {
  <app-project-skeleton />
  } @else if (!store.project()) {
  <div class="min-h-[75vh] w-full flex flex-col justify-center items-center">
    <h2 class="text-3xl font-semibold text-gray-700">{{ 'project_detail.detail.not_found' | translate }}</h2>
  </div>
  }
</section>

<p-dialog
  header="{{ 'project_detail.detail.phase_resources' | translate }}"
  [visible]="showResourcesDialog()"
  (visibleChange)="showResourcesDialog.set($event)"
  [modal]="true"
  [dismissableMask]="true"
  [draggable]="false"
  [resizable]="false"
  [baseZIndex]="1200"
  [style]="{ width: 'min(720px, 90vw)' }"
  styleClass="rounded-lg"
  [contentStyle]="{ padding: '0.5rem', background: 'white', overflowY: 'auto', maxHeight: '80vh', minHeight: '50vh' }">
  <ng-template pTemplate="header">
    <div class="flex items-center justify-between w-full py-1">
      <h2 class="text-lg sm:text-xl font-semibold text-primary-700 truncate">
        {{ 'project_detail.detail.resources' | translate }}
      </h2>
    </div>
  </ng-template>

  <div class="p-4">
    @if (resourcesLoading()) {
    <div class="text-gray-500 italic p-4">{{ 'common.loading' | translate }}</div>
    } @else { @if (selectedResources().length === 0) {
    <div class="text-gray-500 italic p-4">{{ 'project_detail.detail.no_resource' | translate }}</div>
    } @else {
    <ul class="space-y-2 sm:space-y-3 p-2">
      @for (resource of selectedResources(); track $index) {
      <li
        class="flex items-center justify-between gap-2 sm:gap-3 bg-white border border-gray-200 rounded-lg px-3 py-2 sm:px-4 sm:py-3 shadow-sm hover:bg-gray-50 hover:shadow-md transition cursor-pointer transform hover:scale-102">
        <div class="flex items-center gap-2 sm:gap-3">
          <span
            class="w-6 h-6 sm:w-7 sm:h-7 rounded-full bg-primary-100 text-primary-600 flex items-center justify-center flex-shrink-0">
            <i-lucide [name]="icons.fileText" class="size-4"></i-lucide>
          </span>
          <span class="font-semibold text-gray-900 line-clamp-1 text-xs sm:text-sm">{{ resource.title }}</span>
        </div>
        <span
          class="px-2 py-1 max-w-[ch] rounded-full bg-primary-100 text-primary-700 text-xs font-medium flex-shrink-0"
          >{{ resource.type }}</span
        >
        <div class="flex items-center gap-2">
          @if (resource.type === 'LINK') {
          <a
            [href]="resource.url"
            target="_blank"
            rel="noopener"
            class="inline-flex items-center gap-2 px-3 py-1 rounded-md border border-gray-200 text-sm bg-white hover:bg-gray-50"
            >Ouvrir le lien</a
          >
          } @else if (resource.type === 'PDF' || resource.type === 'OTHER') {

          <a
            [href]="getResourceUrl(resource)"
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-1.5 text-xs text-primary-600 hover:text-primary-700 font-medium hover:underline transition-colors duration-200">
            <span>Voir la ressource</span>
            <i-lucide [name]="icons.external" class="size-3" />
          </a>

          } @else if (resource.type === 'IMAGE') {
          <a [href]="resource.url" target="_blank" rel="noopener">
            <img [src]="resource.url" alt="{{ resource.title }}" class="h-8 w-8 rounded shadow border" />
          </a>
          } @else {
          <a
            [href]="resource.url"
            target="_blank"
            rel="noopener"
            class="inline-flex items-center gap-2 px-3 py-1 rounded-md border border-gray-200 text-sm bg-white hover:bg-gray-50"
            >{{ 'project_detail.detail.view' | translate }}</a
          >
          }
        </div>
      </li>
      }
    </ul>
    } @if (selectedForms().length > 0) {
    <div class="mt-6 flex gap-2 flex-wrap justify-center p-2">
      @for (form of selectedForms(); track $index) {
      <p-button
        (click)="openFormDialog(form)"
        styleClass="inline-flex items-center gap-2 px-3 py-2 rounded-md bg-primary-50 text-primary-700 border border-primary-200 hover:bg-primary-100 text-sm font-semibold">
        {{$index + 1}}. {{ form.title }}
        <i-lucide [name]="icons.arrow"></i-lucide>
      </p-button>
      }
    </div>
    } }
  </div>
</p-dialog>

@if (selectedFormGroup()) {
<p-dialog
  header="{{ 'project_detail.detail.form_title' | translate }}"
  [visible]="showFormDialog()"
  (visibleChange)="showFormDialog.set($event)"
  [modal]="true"
  [dismissableMask]="true"
  [draggable]="false"
  [resizable]="false"
  [baseZIndex]="1200"
  [style]="{ width: 'min(900px, 90vw)' }"
  styleClass="rounded-lg"
  [contentStyle]="{ padding: '0', background: 'white', borderRadius: '0 0 1rem 1rem', overflowY: 'auto', maxHeight: '85vh', minHeight: '50vh' }">
  <!-- Header -->
  <ng-template pTemplate="header">
    <div class="flex items-center justify-between w-full py-1">
      <h2 class="text-lg sm:text-xl font-semibold text-primary-700 truncate">
        {{ selectedForm()?.title || ('project_detail.detail.form_title' | translate) }}
      </h2>
    </div>
  </ng-template>

  <div class="p-4 sm:p-6 space-y-6">
    @if (selectedForm(); as form) {

    <div
      class="rounded-lg border border-primary-100 bg-gradient-to-br from-primary-50/40 to-white shadow p-4 sm:p-6 space-y-5">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <h3 class="text-xl font-semibold text-gray-900">{{ form.title }}</h3>

        <span
          class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium border"
          [ngClass]="
            form.is_active
              ? 'bg-primary-50 text-primary-700 border-primary-200'
              : 'bg-gray-100 text-gray-700 border-gray-200'
          ">
          {{ form.is_active ? ('project_detail.detail.form_active' | translate) : ('project_detail.detail.form_inactive'
          | translate) }}
        </span>
      </div>

      <form class="space-y-4" [formGroup]="selectedFormGroup()!" (ngSubmit)="onSubmitPreview(form)">
        @for (field of form.fields; track $index) {

        <div class="bg-white rounded-lg border border-gray-200 p-4 space-y-2">
          <label class="text-sm font-medium text-gray-800 block" [for]="field.id">
            {{ field.label }} @if (field.required) { <span class="text-red-500">*</span> }
          </label>

          @if (field.description) {
          <p class="text-xs text-gray-500">{{ field.description }}</p>
          } @switch (normalizeType(field.type)) { @case('SHORT_TEXT') {
          <input
            type="text"
            [formControlName]="field.id"
            [placeholder]="field.placeholder || ''"
            class="w-full px-3 py-2 rounded-md border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary-300" />
          } @case('LONG_TEXT') {
          <textarea
            rows="3"
            [formControlName]="field.id"
            [placeholder]="field.placeholder || ''"
            class="w-full px-3 py-2 rounded-md border border-gray-200 min-h-[100px] focus:outline-none focus:ring-2 focus:ring-primary-300"></textarea>
          } @case('EMAIL') {
          <input
            type="email"
            [formControlName]="field.id"
            [placeholder]="field.placeholder || 'email@example.com'"
            class="w-full px-3 py-2 rounded-md border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary-300"
            required
            pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$" />
          } @case('PHONE') {
          <input
            type="tel"
            [formControlName]="field.id"
            [placeholder]="field.placeholder || '+243...'"
            class="w-full px-3 py-2 rounded-md border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary-300"
            required
            pattern="^\+?[0-9\s\-]{7,}$" />
          } @case('NUMBER') {
          <input
            type="number"
            [formControlName]="field.id"
            class="w-full px-3 py-2 rounded-md border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary-300"
            min="0"
            step="any" />
          } @case('DATE') {
          <input
            type="date"
            [formControlName]="field.id"
            class="w-full px-3 py-2 rounded-md border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary-300" />
          } @case('DROPDOWN') {
          <select
            [formControlName]="field.id"
            class="w-full px-3 py-2 rounded-md border border-gray-200 focus:outline-none">
            <option value="" disabled>{{ 'project_detail.detail.choose_option' | translate }}</option>
            @for (option of field.options || []; track option.value) {
            <option [value]="option.value">{{ option.label }}</option>
            }
          </select>
          } @case('MULTI_SELECT') {
          <select
            multiple
            [formControlName]="field.id"
            class="w-full px-3 py-2 rounded-md border border-gray-200 focus:outline-none">
            @for (option of field.options || []; track option.value) {
            <option [value]="option.value">{{ option.label }}</option>
            }
          </select>
          } @case('CHECKBOX') {
          <div class="flex flex-wrap gap-3">
            @for (option of field.options || []; track option.value) {
            <label class="inline-flex items-center gap-2 text-sm text-gray-700">
              <input
                type="checkbox"
                class="rounded border-gray-300 text-primary-600"
                [checked]="getFieldArrayValue(selectedFormGroup()!, field.id).includes(option.value)"
                (change)="onToggleCheckboxValue(selectedFormGroup()!, field.id, option.value, $any($event.target).checked)" />
              {{ option.label }}
            </label>
            }
          </div>
          } @case('RADIO') {
          <div class="flex flex-col gap-2">
            @for (option of field.options || []; track option.value) {
            <label class="inline-flex items-center gap-2 text-sm text-gray-700">
              <input type="radio" [value]="option.value" [formControlName]="field.id" class="text-primary-600" />
              {{ option.label }}
            </label>
            }
          </div>
          } @case('FILE_UPLOAD') {
          <input
            type="file"
            class="block w-full text-sm text-gray-600 file:py-2 file:px-4 file:rounded-md file:bg-primary-50 file:text-primary-700"
            (change)="selectedFormGroup()!.get(field.id)?.setValue($any($event.target).files?.[0] ?? null)" />
          } @default {
          <input
            class="w-full px-3 py-2 rounded-md border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary-300"
            [formControlName]="field.id" />
          } } @if (field.helperText) {
          <p class="text-xs text-gray-500">{{ field.helperText }}</p>
          } @if (selectedFormGroup()!.get(field.id)?.invalid && selectedFormGroup()!.get(field.id)?.touched) { @if
          (selectedFormGroup()!.get(field.id)?.errors?.['required']) {
          <p class="text-xs text-red-500">{{ 'project_detail.detail.validation.required' | translate }}</p>
          } @if (selectedFormGroup()!.get(field.id)?.errors?.['email'] ||
          selectedFormGroup()!.get(field.id)?.errors?.['pattern']) {
          <p class="text-xs text-red-500">{{ 'project_detail.detail.validation.email' | translate }}</p>
          } @if (selectedFormGroup()!.get(field.id)?.errors?.['min']) {
          <p class="text-xs text-red-500">La valeur doit être supérieure ou égale à 0.</p>
          } @if (selectedFormGroup()!.get(field.id)?.errors?.['pattern'] && normalizeType(field.type) === 'PHONE') {
          <p class="text-xs text-red-500">{{ 'project_detail.detail.validation.phone' | translate }}</p>
          } }
        </div>
        }

        <div class="flex justify-end">
          <p-button
            type="submit"
            severity="primary"
            size="small"
            styleClass="inline-flex items-center gap-2 px-4 py-2 rounded-md bg-primary-600 text-white hover:bg-primary-700 font-semibold w-full sm:w-auto">
            {{ 'common.submit' | translate }}
          </p-button>
        </div>
      </form>
    </div>

    }
  </div>
</p-dialog>

}
